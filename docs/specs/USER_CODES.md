# User Codes & Verification Lifecycle

This document describes the mechanics of `userCode` (referral codes) and the verification validity periods in the Solana Age Verify system.

## User Codes (Referral Codes)

To facilitate a referral system, the program generates a `userCode` for verified adults.

### Properties
- **Memorable**: 5-character alphanumeric string (e.g., `B3K9A`).
- **Deterministic**: Derived from the user's Verification PDA, ensuring it remains the same for the user across re-verifications.
- **Adult-Only**: Only users verified as 18+ receive a `userCode`. Minor verifications will have an empty user code field.
- **Immutable**: Once assigned, the code never changes for that user, even after their verification expires and they re-verify.

### Generation Logic
The code is generated by XORing bytes of the Program Derived Address (PDA) and mapping them to a curated charset: `ABCDEFGHIJKLMNPQRSTUVWXYZ23456789`.

### Storage and Fetchability
The `userCode` is stored in the verification record PDA as part of the on-chain account data. It can be fetched later via standard RPC or the SDK helper `fetchCredential`. See `packages/age-verify-sdk/src/validate.ts` for the implementation.

## Verification Lifecycle

Verification records are stored on-chain but have built-in expiration logic. Users must re-verify once their record expires to maintain "Verified" status.

### Expiration Rules
- **Adults (18+)**: 90 days.
- **Minors (< 18)**: 30 days.

### Re-verification
- **Before Expiration**: Re-verification is blocked. Users cannot "refresh" their verification until the current one has expired.
- **After Expiration**: Users can run the verification process again.
- **Rent Handling**: If a user wishes to close their account and reclaim rent, they can call the `close_verification` instruction. Re-verifying will then re-initialize the account. If they re-verify without closing, the existing account is updated.

## Fees

The verification process involves two types of fees to ensure the sustainability of the platform and incentivize integrators.

### 1. Protocol Fee
A fixed protocol fee (currently **0.0005 SOL** or 500,000 lamports) is charged for every on-chain verification attempt. This fee covers the cost of PDA creation, infrastructure, and maintenance of the Solana Age Verify protocol.

### 2. Integrator (App) Fee
Integrators (websites or applications using the SDK) can optionally configure an additional fee. This fee is directed to the integrator's treasury and is displayed to the user during the signing process. If no app fee is configured, only the protocol fee is shown.
